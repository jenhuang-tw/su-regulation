name: Update Law List

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ public/regulations ç›®éŒ„ä¸‹çš„æª”æ¡ˆæœ‰è®Šå‹•æ™‚
on:
  push:
    paths:
      - 'public/regulations/**'
    branches:
      - main
      - master
  pull_request:
    paths:
      - 'public/regulations/**'
    types:
      - closed
    branches:
      - main
      - master

jobs:
  update-lawlist:
    # åªæœ‰åœ¨ PR è¢«åˆä½µæˆ–æ˜¯ç›´æŽ¥æŽ¨é€åˆ°ä¸»åˆ†æ”¯æ™‚æ‰åŸ·è¡Œ
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    runs-on: ubuntu-latest
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        # éœ€è¦å®Œæ•´çš„ git æ­·å²è¨˜éŒ„ä¾†æª¢æ¸¬è®Šæ›´
        fetch-depth: 0
        # ä½¿ç”¨ GitHub Token ä¾†å…è¨±æŽ¨é€è®Šæ›´
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: è¨­å®š Node.js ç’°å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£ç›¸ä¾å¥—ä»¶
      run: |
        npm ci
    
    - name: æª¢æŸ¥ public/regulations ç›®éŒ„è®Šæ›´
      id: check-changes
      run: |
        # æª¢æŸ¥ public/regulations ç›®éŒ„ä¸‹æ˜¯å¦æœ‰ .txt æª”æ¡ˆè®Šæ›´
        if [ "${{ github.event_name }}" == "push" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^public/regulations/.*\.txt$' || true)
        else
          # PR åˆä½µçš„æƒ…æ³
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep '^public/regulations/.*\.txt$' || true)
        fi
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "has-changes=true" >> $GITHUB_OUTPUT
          echo "è®Šæ›´çš„æª”æ¡ˆ:"
          echo "$CHANGED_FILES"
        else
          echo "has-changes=false" >> $GITHUB_OUTPUT
          echo "æ²’æœ‰æª¢æ¸¬åˆ° .txt æª”æ¡ˆè®Šæ›´"
        fi
    
    - name: åŸ·è¡Œæ³•è¦åˆ—è¡¨æ›´æ–°
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        node update-regulation-list.js
    
    - name: æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
      if: steps.check-changes.outputs.has-changes == 'true'
      id: check-git-changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šæ›´
        if git diff --quiet pages/index.vue; then
          echo "git-changes=false" >> $GITHUB_OUTPUT
          echo "pages/index.vue æ²’æœ‰è®Šæ›´"
        else
          echo "git-changes=true" >> $GITHUB_OUTPUT
          echo "pages/index.vue æœ‰è®Šæ›´"
        fi
    
    - name: æäº¤è®Šæ›´
      if: steps.check-changes.outputs.has-changes == 'true' && steps.check-git-changes.outputs.git-changes == 'true'
      run: |
        git add pages/index.vue
        git commit -m "chore: è‡ªå‹•æ›´æ–°æ³•è¦åˆ—è¡¨ (lawList)
        
        - æª¢æ¸¬åˆ° public/regulations ç›®éŒ„ä¸‹çš„ .txt æª”æ¡ˆæœ‰è®Šæ›´
        - è‡ªå‹•æ›´æ–° pages/index.vue ä¸­çš„ lawList é™£åˆ—
        - ç”± GitHub Actions è‡ªå‹•åŸ·è¡Œ"
        
        git push
    
    - name: æ›´æ–°çµæžœæ‘˜è¦
      if: steps.check-changes.outputs.has-changes == 'true'
      run: |
        echo "## ðŸ“‹ æ³•è¦åˆ—è¡¨æ›´æ–°çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-git-changes.outputs.git-changes }}" == "true" ]; then
          echo "âœ… **æˆåŠŸæ›´æ–°æ³•è¦åˆ—è¡¨**" >> $GITHUB_STEP_SUMMARY
          echo "- åµæ¸¬åˆ° public/regulations ç›®éŒ„ä¸‹çš„ .txt æª”æ¡ˆè®Šæ›´" >> $GITHUB_STEP_SUMMARY
          echo "- å·²è‡ªå‹•æ›´æ–° pages/index.vue ä¸­çš„ lawList é™£åˆ—" >> $GITHUB_STEP_SUMMARY
          echo "- è®Šæ›´å·²æäº¤è‡³ç‰ˆæœ¬æŽ§åˆ¶" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **ç„¡éœ€æ›´æ–°**" >> $GITHUB_STEP_SUMMARY
          echo "- é›–ç„¶æª¢æ¸¬åˆ° .txt æª”æ¡ˆè®Šæ›´ï¼Œä½† lawList å…§å®¹ç„¡éœ€æ›´æ–°" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ç•¶å‰æ³•è¦åˆ—è¡¨:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        node -e "
          import('./update-regulation-list.js').then(module => {
            const lawList = module.scanRegulations();
            console.log('const lawList = [');
            lawList.forEach(law => console.log(\`  [\${law[0]},'\${law[1]}'],\`));
            console.log('];');
          });
        " >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY